<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>XArm6 Demo Dashboard</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      padding: 16px 24px;
      background: #020617;
      border-bottom: 1px solid #1f2937;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      margin: 0;
      font-size: 1.3rem;
    }
    main {
      flex: 1;
      padding: 16px 24px 24px;
      display: grid;
      grid-template-columns: 2fr 1.2fr;
      grid-gap: 16px;
    }
    .card {
      background: #020617;
      border-radius: 12px;
      padding: 16px;
      border: 1px solid #1f2937;
      box-shadow: 0 10px 25px rgba(0,0,0,0.45);
    }
    .card h2 {
      margin-top: 0;
      font-size: 1.1rem;
      margin-bottom: 8px;
    }
    .cams-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-gap: 8px;
    }
    .cam-box {
      border-radius: 10px;
      overflow: hidden;
      background: #020617;
      border: 1px solid #1f2937;
      display: flex;
      flex-direction: column;
    }
    .cam-box-header {
      padding: 6px 10px;
      font-size: 0.85rem;
      border-bottom: 1px solid #1f2937;
      background: #050816;
    }
    .cam-box img {
      width: 100%;
      height: auto;
      display: block;
      background: #111827;
    }
    .status-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.8rem;
      border: 1px solid #1f2937;
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
    }
    .status-idle   { background: #4b5563; }
    .status-busy   { background: #fbbf24; }
    .status-ready  { background: #22c55e; }
    .status-error  { background: #ef4444; }

    button {
      border-radius: 999px;
      padding: 8px 16px;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    button.primary {
      background: linear-gradient(to right, #22c55e, #14b8a6);
      color: #020617;
    }
    button.secondary {
      background: #020617;
      border: 1px solid #374151;
      color: #e5e7eb;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .log {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background: #020617;
      border-radius: 8px;
      border: 1px solid #1f2937;
      padding: 8px;
      font-size: 0.78rem;
      max-height: 220px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    .meta-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 8px 0;
      font-size: 0.8rem;
      color: #9ca3af;
    }
    .meta-row span {
      border-radius: 999px;
      padding: 3px 10px;
      background: #020617;
      border: 1px solid #111827;
    }
    footer {
      padding: 8px 16px;
      font-size: 0.75rem;
      color: #6b7280;
      background: #020617;
      border-top: 1px solid #111827;
      text-align: right;
    }
  </style>
</head>
<body>
  <header>
    <h1>XArm6 Policy Server Dashboard</h1>
    <div>
      <button id="run-btn" class="primary">▶ Run Policy Server</button>
      <button id="health-btn" class="secondary" style="margin-left: 8px;">❤️ Check Health</button>
    </div>
  </header>

  <main>
    <section class="card">
      <h2>Camera Feeds</h2>
      <div class="cams-grid">
        <div class="cam-box">
          <div class="cam-box-header">Base Camera</div>
          <img src="/video/base" alt="Base camera stream" />
        </div>
        <div class="cam-box">
          <div class="cam-box-header">Wrist Camera</div>
          <img src="/video/wrist" alt="Wrist camera stream" />
        </div>
      </div>
    </section>

    <section class="card">
      <h2>Server & Tunnel Status</h2>
      <div id="status-chip" class="status-chip">
        <div id="status-dot" class="status-dot status-idle"></div>
        <span id="status-text">IDLE</span>
      </div>

      <div class="meta-row">
        <span id="meta-job">Job: —</span>
        <span id="meta-remote">Remote: —</span>
        <span id="meta-server">Server: NOT RUNNING</span>
      </div>

      <div style="margin-top: 8px; font-size: 0.8rem; color: #9ca3af;">
        <strong>Last message:</strong>
      </div>
      <div id="last-message" class="log"></div>
    </section>
  </main>

  <footer>
    XArm6 demo • Orchestrator-backed • MJPEG cameras
  </footer>

  <script>
    const statusDot = document.getElementById("status-dot");
    const statusText = document.getElementById("status-text");
    const metaJob = document.getElementById("meta-job");
    const metaRemote = document.getElementById("meta-remote");
    const metaServer = document.getElementById("meta-server");
    const lastMessage = document.getElementById("last-message");
    const runBtn = document.getElementById("run-btn");
    const healthBtn = document.getElementById("health-btn");

    function updateStatusView(data) {
      const state = (data.state || "IDLE").toUpperCase();
      const msg = data.message || "";
      const jobId = data.job_id || "—";
      const remote = (data.remote_ip && data.remote_port)
        ? `${data.remote_ip}:${data.remote_port}`
        : "—";
      const serverRunning = !!data.server_running;

      statusText.textContent = state;
      lastMessage.textContent = msg;
      metaJob.textContent = `Job: ${jobId}`;
      metaRemote.textContent = `Remote: ${remote}`;
      metaServer.textContent = `Server: ${serverRunning ? "RUNNING" : "NOT RUNNING"}`;

      statusDot.className = "status-dot";
      if (state === "READY") {
        statusDot.classList.add("status-ready");
      } else if (state.startsWith("ERROR")) {
        statusDot.classList.add("status-error");
      } else if (state === "IDLE") {
        statusDot.classList.add("status-idle");
      } else {
        statusDot.classList.add("status-busy");
      }

      // Button enable/disable:
      const busyStates = [
        "CLEARING_OLD_ENDPOINT",
        "SUBMITTING_JOB",
        "JOB_QUEUED",
        "JOB_RUNNING_STARTING_SERVER",
        "SERVER_READY_NO_TUNNEL",
        "STARTING_TUNNEL",
        "CHECKING_POLICY_HEALTH",
      ];

      if (state === "READY") {
        runBtn.disabled = true;
        runBtn.textContent = "Server running";
      } else if (busyStates.includes(state)) {
        runBtn.disabled = true;
        runBtn.textContent = "Running...";
      } else {
        runBtn.disabled = false;
        runBtn.textContent = "▶ Run Policy Server";
      }
    }

    async function fetchStatus() {
      try {
        const resp = await fetch("/api/status");
        if (!resp.ok) return;
        const data = await resp.json();
        updateStatusView(data);
      } catch (e) {
        console.error("Status poll failed:", e);
      }
    }

    async function runServer() {
      try {
        const resp = await fetch("/api/run-server", { method: "POST" });
        if (!resp.ok) {
          const text = await resp.text();
          alert("Failed to start server: " + text);
        }
      } catch (e) {
        alert("Error starting server: " + e);
      }
    }

    async function runHealthCheck() {
      try {
        const resp = await fetch("/api/health");
        const data = await resp.json();
        alert("Health check: " + data.status + (data.detail ? ("\\n" + data.detail) : ""));
      } catch (e) {
        alert("Health check failed: " + e);
      }
    }

    runBtn.addEventListener("click", runServer);
    healthBtn.addEventListener("click", runHealthCheck);

    // Poll status every 2 seconds
    fetchStatus();
    setInterval(fetchStatus, 2000);
  </script>
</body>
</html>