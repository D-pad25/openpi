<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>XArm6 Demo Dashboard</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      padding: 16px 24px;
      background: #020617;
      border-bottom: 1px solid #1f2937;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    header h1 {
      margin: 0;
      font-size: 1.3rem;
    }
    main {
      flex: 1;
      padding: 16px 24px 24px;
      display: grid;
      grid-template-columns: 2fr 1.3fr;
      grid-gap: 16px;
    }
    .card {
      background: #020617;
      border-radius: 12px;
      padding: 16px;
      border: 1px solid #1f2937;
      box-shadow: 0 10px 25px rgba(0,0,0,0.45);
    }
    .card h2 {
      margin-top: 0;
      font-size: 1.1rem;
      margin-bottom: 8px;
    }
    .cams-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-gap: 8px;
    }
    .cam-box {
      border-radius: 10px;
      overflow: hidden;
      background: #020617;
      border: 1px solid #1f2937;
      display: flex;
      flex-direction: column;
    }
    .cam-box-header {
      padding: 6px 10px;
      font-size: 0.85rem;
      border-bottom: 1px solid #1f2937;
      background: #050816;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .cam-box img {
      width: 100%;
      height: auto;
      display: block;
      background: #111827;
    }
    .status-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.8rem;
      border: 1px solid #1f2937;
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
    }
    .status-idle   { background: #4b5563; }
    .status-busy   { background: #fbbf24; }
    .status-ready  { background: #22c55e; }
    .status-error  { background: #ef4444; }

    button {
      border-radius: 999px;
      padding: 8px 16px;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }
    button.primary {
      background: linear-gradient(to right, #22c55e, #14b8a6);
      color: #020617;
    }
    button.secondary {
      background: #020617;
      border: 1px solid #374151;
      color: #e5e7eb;
    }
    button.danger {
      background: #450a0a;
      border: 1px solid #7f1d1d;
      color: #fecaca;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .log {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background: #020617;
      border-radius: 8px;
      border: 1px solid #1f2937;
      padding: 8px;
      font-size: 0.78rem;
      max-height: 220px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    .meta-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 8px 0;
      font-size: 0.8rem;
      color: #9ca3af;
    }
    .meta-row span {
      border-radius: 999px;
      padding: 3px 10px;
      background: #020617;
      border: 1px solid #111827;
    }
    footer {
      padding: 8px 16px;
      font-size: 0.75rem;
      color: #6b7280;
      background: #020617;
      border-top: 1px solid #111827;
      text-align: right;
    }
    .cam-status {
      font-size: 0.75rem;
      margin-left: 8px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid #1f2937;
    }
    .cam-online {
      background: #14532d;
      color: #bbf7d0;
    }
    .cam-offline {
      background: #450a0a;
      color: #fecaca;
    }

    .right-col {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .xarm-controls label {
      display: block;
      font-size: 0.8rem;
      margin-bottom: 4px;
      color: #9ca3af;
    }
    #xarm-prompt {
      width: 100%;
      min-height: 60px;
      resize: vertical;
      border-radius: 8px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      padding: 6px 8px;
      font-size: 0.85rem;
      font-family: inherit;
    }
    .xarm-buttons {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    .xarm-status-pill {
      font-size: 0.75rem;
      padding: 3px 10px;
      border-radius: 999px;
      border: 1px solid #1f2937;
    }
    .xarm-status-idle {
      background: #111827;
      color: #e5e7eb;
    }
    .xarm-status-running {
      background: #14532d;
      color: #bbf7d0;
    }
    .xarm-status-ok {
      background: #0f766e;
      color: #a5f3fc;
    }
    .xarm-status-error {
      background: #450a0a;
      color: #fecaca;
    }
    .xarm-log-header {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-bottom: 4px;
    }

    .mode-toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #020617;
      font-size: 0.8rem;
    }
    .mode-toggle span.label {
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 0.7rem;
      color: #9ca3af;
    }
    .mode-toggle label {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }
    .mode-toggle input[type="radio"] {
      accent-color: #22c55e;
    }

    .small-muted {
      margin-top: 6px;
      font-size: 0.75rem;
      color: #94a3b8;
    }
  </style>
</head>
<body>
  <header>
    <h1>XArm6 Policy Server Dashboard</h1>
    <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
      <div class="mode-toggle">
        <span class="label">Mode</span>
        <label>
          <input type="radio" name="server-mode" value="local">
          Local
        </label>
        <label>
          <input type="radio" name="server-mode" value="hpc">
          HPC
        </label>
      </div>
      <button id="run-btn" class="primary">‚ñ∂ Run Policy Server</button>
      <button id="stop-btn" class="danger">‚èª Shutdown Server</button>
      <button id="health-btn" class="secondary">‚ù§Ô∏è Check Health</button>
      <button id="cam-btn" class="secondary">üì∑ Start Camera Server</button>
    </div>
  </header>

  <main>
    <!-- Left: cameras -->
    <section class="card">
      <h2>Camera Feeds</h2>
      <div class="cams-grid">
        <div class="cam-box">
          <div class="cam-box-header">
            <span>Base Camera</span>
            <span class="cam-status cam-offline" id="base-status">DISCONNECTED</span>
          </div>
          <img src="/video/base" alt="Base camera stream" />
        </div>
        <div class="cam-box">
          <div class="cam-box-header">
            <span>Wrist Camera</span>
            <span class="cam-status cam-offline" id="wrist-status">DISCONNECTED</span>
          </div>
          <img src="/video/wrist" alt="Wrist camera stream" />
        </div>
      </div>
    </section>

    <!-- Right: server + logs + xArm client stacked -->
    <div class="right-col">
      <section class="card">
        <h2>Server & Tunnel Status</h2>
        <div id="status-chip" class="status-chip">
          <div id="status-dot" class="status-dot status-idle"></div>
          <span id="status-text">IDLE</span>
        </div>

        <div class="meta-row">
          <span id="meta-job">Job: ‚Äî</span>
          <span id="meta-remote">Remote: ‚Äî</span>
          <span id="meta-server">Server: NOT RUNNING</span>
        </div>

        <div style="margin-top: 8px; font-size: 0.8rem; color: #9ca3af;">
          <strong>Last message:</strong>
        </div>
        <div id="last-message" class="log"></div>

        <div class="small-muted">
          Tip: In HPC mode, timeouts/health failures may include qstat/qpeek output in the message above.
        </div>
      </section>

      <section class="card">
        <h2>Policy Server Log (Local)</h2>
        <div class="meta-row">
          <span id="policy-log-rc">RC: ‚Äî</span>
          <span id="policy-log-running">Running: ‚Äî</span>
        </div>
        <pre id="policy-log" class="log"></pre>
        <div class="small-muted">Local-only. HPC logs are surfaced via orchestrator messages and diagnostics.</div>
      </section>

      <section class="card">
        <h2>xArm Client</h2>
        <div class="xarm-controls">
          <label for="xarm-prompt">Prompt</label>
          <textarea id="xarm-prompt">Pick a ripe, red tomato and drop it in the blue bucket. [crop=tomato]</textarea>
        </div>

        <div class="xarm-buttons">
          <button id="xarm-run-btn" class="primary">‚ñ∂ Run xArm Client</button>
          <button id="xarm-stop-btn" class="secondary" disabled>‚èπ Stop</button>
          <span id="xarm-status-label" class="xarm-status-pill xarm-status-idle">IDLE</span>
        </div>

        <div class="xarm-log-header">Client log</div>
        <pre id="xarm-log" class="log"></pre>
      </section>
    </div>
  </main>

  <footer>
    XArm6 demo ‚Ä¢ Orchestrator-backed ‚Ä¢ MJPEG cameras ‚Ä¢ xArm client
  </footer>

  <script>
    const statusDot = document.getElementById("status-dot");
    const statusText = document.getElementById("status-text");
    const metaJob = document.getElementById("meta-job");
    const metaRemote = document.getElementById("meta-remote");
    const metaServer = document.getElementById("meta-server");
    const lastMessage = document.getElementById("last-message");
    const runBtn = document.getElementById("run-btn");
    const stopBtn = document.getElementById("stop-btn");
    const healthBtn = document.getElementById("health-btn");
    const camBtn = document.getElementById("cam-btn");

    const baseStatus = document.getElementById("base-status");
    const wristStatus = document.getElementById("wrist-status");

    const xarmRunBtn = document.getElementById("xarm-run-btn");
    const xarmStopBtn = document.getElementById("xarm-stop-btn");
    const xarmPromptInput = document.getElementById("xarm-prompt");
    const xarmStatusLabel = document.getElementById("xarm-status-label");
    const xarmLogElem = document.getElementById("xarm-log");

    const policyLogElem = document.getElementById("policy-log");
    const policyLogRC = document.getElementById("policy-log-rc");
    const policyLogRunning = document.getElementById("policy-log-running");

    function setRadios(mode) {
      const radios = document.querySelectorAll('input[name="server-mode"]');
      radios.forEach(r => r.checked = (r.value === mode));
    }

    function updateStatusView(data) {
      const state = (data.state || "IDLE").toUpperCase();
      const msg = data.message || "";
      const jobId = data.job_id || "‚Äî";
      const remote = (data.remote_ip && data.remote_port)
        ? `${data.remote_ip}:${data.remote_port}`
        : "‚Äî";
      const serverRunning = !!data.server_running;
      const busy = !!data.busy;

      const activeMode = (data.server_mode || "local").toLowerCase();
      const preferredMode = (data.preferred_mode || activeMode).toLowerCase();

      // When idle and not busy, reflect preferred mode. Otherwise reflect active mode.
      const displayMode = (!serverRunning && !busy) ? preferredMode : activeMode;
      setRadios(displayMode);

      statusText.textContent = serverRunning
        ? `${state} (${displayMode.toUpperCase()})`
        : `${state} (${displayMode.toUpperCase()})`;

      lastMessage.textContent = msg;
      metaJob.textContent = `Job: ${displayMode === "hpc" ? jobId : "‚Äî"}`;
      metaRemote.textContent = `Remote: ${displayMode === "hpc" ? remote : "‚Äî"}`;
      metaServer.textContent = serverRunning
        ? `Server: RUNNING (${displayMode.toUpperCase()})`
        : "Server: NOT RUNNING";

      statusDot.className = "status-dot";
      if (state === "READY") {
        statusDot.classList.add("status-ready");
      } else if (state.startsWith("ERROR")) {
        statusDot.classList.add("status-error");
      } else if (busy || state.includes("START") || state.includes("CHECK") || state.includes("SUBMIT") || state.includes("WAIT")) {
        statusDot.classList.add("status-busy");
      } else {
        statusDot.classList.add("status-idle");
      }

      // Buttons
      if (serverRunning) {
        runBtn.disabled = true;
        runBtn.textContent = displayMode === "local" ? "Local server running" : "Server running";
        stopBtn.disabled = false;
      } else if (busy) {
        runBtn.disabled = true;
        runBtn.textContent = "Starting...";
        stopBtn.disabled = false; // allow cancel during startup
      } else {
        runBtn.disabled = false;
        runBtn.textContent = "‚ñ∂ Run Policy Server";
        stopBtn.disabled = true; // nothing to stop
      }
    }

    function updateCameraStatusView(data) {
      function apply(elem, s) {
        if (!elem || !s) return;
        const online = !!s.online;
        elem.className = "cam-status " + (online ? "cam-online" : "cam-offline");
        elem.textContent = online ? "ONLINE" : "DISCONNECTED";
      }

      apply(baseStatus, data.base);
      apply(wristStatus, data.wrist);

      const serverRunning = !!data.server_running;
      if (serverRunning) {
        camBtn.disabled = true;
        camBtn.textContent = "üì∑ Camera Server Running";
      } else {
        camBtn.disabled = false;
        camBtn.textContent = "üì∑ Start Camera Server";
      }
    }

    function updateXarmView(data) {
      const running = !!data.running;
      const rc = data.returncode;
      const log = data.log || "";

      xarmLogElem.textContent = log;

      if (running) {
        xarmStatusLabel.textContent = "RUNNING";
        xarmStatusLabel.className = "xarm-status-pill xarm-status-running";
        xarmRunBtn.disabled = true;
        xarmStopBtn.disabled = false;
      } else {
        let label = "IDLE";
        let cls = "xarm-status-pill ";
        if (rc === null || typeof rc === "undefined") {
          cls += "xarm-status-idle";
        } else if (rc === 0) {
          label = "FINISHED";
          cls += "xarm-status-ok";
        } else {
          label = "ERROR (" + rc + ")";
          cls += "xarm-status-error";
        }
        xarmStatusLabel.textContent = label;
        xarmStatusLabel.className = cls;
        xarmRunBtn.disabled = false;
        xarmStopBtn.disabled = true;
      }
    }

    function updatePolicyLogView(data) {
      policyLogElem.textContent = data.log || "";
      policyLogRC.textContent = "RC: " + (data.local_returncode === null || typeof data.local_returncode === "undefined" ? "‚Äî" : data.local_returncode);
      policyLogRunning.textContent = "Running: " + (data.local_running ? "YES" : "NO");
    }

    async function fetchStatus() {
      try {
        const resp = await fetch("/api/status");
        if (!resp.ok) return;
        const data = await resp.json();
        updateStatusView(data);
      } catch (e) {
        console.error("Status poll failed:", e);
      }
    }

    async function fetchCameraStatus() {
      try {
        const resp = await fetch("/api/camera-status");
        if (!resp.ok) return;
        const data = await resp.json();
        updateCameraStatusView(data);
      } catch (e) {
        console.error("Camera status poll failed:", e);
      }
    }

    async function fetchXarmStatus() {
      try {
        const resp = await fetch("/api/xarm-status");
        if (!resp.ok) return;
        const data = await resp.json();
        updateXarmView(data);
      } catch (e) {
        console.error("xArm status poll failed:", e);
      }
    }

    async function fetchPolicyLog() {
      try {
        const resp = await fetch("/api/policy-server-log");
        if (!resp.ok) return;
        const data = await resp.json();
        updatePolicyLogView(data);
      } catch (e) {
        console.error("policy log poll failed:", e);
      }
    }

    async function setMode(mode) {
      try {
        const resp = await fetch("/api/set-mode", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ mode }),
        });
        if (!resp.ok) {
          const text = await resp.text();
          alert("Failed to set mode:\n\n" + text);
          await fetchStatus(); // revert UI to backend
        }
      } catch (e) {
        alert("Error setting mode: " + e);
        await fetchStatus();
      }
    }

    async function runServer() {
      const selected = document.querySelector('input[name="server-mode"]:checked');
      const mode = selected ? selected.value : "local";

      try {
        const resp = await fetch("/api/run-server", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ mode }),
        });
        if (!resp.ok) {
          const text = await resp.text();
          alert("Failed to start server:\n\n" + text);
        }
      } catch (e) {
        alert("Error starting server: " + e);
      }
    }

    async function stopServer() {
      stopBtn.disabled = true;
      try {
        const resp = await fetch("/api/stop-server", { method: "POST" });
        if (!resp.ok) {
          const text = await resp.text();
          alert("Failed to shutdown server:\n\n" + text);
        }
      } catch (e) {
        alert("Error shutting down server: " + e);
      } finally {
        // polling will update actual state
        stopBtn.disabled = false;
      }
    }

    async function runHealthCheck() {
      try {
        const resp = await fetch("/api/health");
        const data = await resp.json();
        alert("Health check: " + data.status + (data.detail ? ("\n\n" + data.detail) : ""));
      } catch (e) {
        alert("Health check failed: " + e);
      }
    }

    async function startCameraServer() {
      camBtn.disabled = true;
      camBtn.textContent = "Starting cameras...";

      try {
        const resp = await fetch("/api/start-cameras", { method: "POST" });
        if (!resp.ok) {
          const text = await resp.text();
          alert("Failed to start camera server:\n\n" + text);
        }
      } catch (e) {
        alert("Error starting camera server: " + e);
      } finally {
        camBtn.textContent = "üì∑ Start Camera Server";
      }
    }

    async function runXarm() {
      xarmRunBtn.disabled = true;
      const prompt = xarmPromptInput ? xarmPromptInput.value : "";

      try {
        const resp = await fetch("/api/run-xarm", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt }),
        });
        if (!resp.ok) {
          const text = await resp.text();
          alert("Failed to start xArm client:\n\n" + text);
        }
      } catch (e) {
        alert("Error starting xArm client: " + e);
      }
    }

    async function stopXarm() {
      xarmStopBtn.disabled = true;
      try {
        const resp = await fetch("/api/stop-xarm", { method: "POST" });
        if (!resp.ok) {
          const text = await resp.text();
          alert("Failed to stop xArm client:\n\n" + text);
        }
      } catch (e) {
        alert("Error stopping xArm client: " + e);
      }
    }

    runBtn.addEventListener("click", runServer);
    stopBtn.addEventListener("click", stopServer);
    healthBtn.addEventListener("click", runHealthCheck);
    camBtn.addEventListener("click", startCameraServer);
    xarmRunBtn.addEventListener("click", runXarm);
    xarmStopBtn.addEventListener("click", stopXarm);

    // Mode radio changes must update backend preference
    document.querySelectorAll('input[name="server-mode"]').forEach(r => {
      r.addEventListener("change", async (ev) => {
        await setMode(ev.target.value);
      });
    });

    // Poll status every 2 seconds
    fetchStatus();
    fetchCameraStatus();
    fetchXarmStatus();
    fetchPolicyLog();
    setInterval(fetchStatus, 2000);
    setInterval(fetchCameraStatus, 2000);
    setInterval(fetchXarmStatus, 2000);
    setInterval(fetchPolicyLog, 2000);
  </script>
</body>
</html>
