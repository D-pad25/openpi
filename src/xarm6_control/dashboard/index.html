<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>XArm6 Demo Dashboard</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f172a;
      --panel2:#0b1326;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --border:#1f2937;
      --ok:#22c55e;
      --warn:#f59e0b;
      --err:#ef4444;
      --btn:#111827;
      --btn2:#0b1b35;
      --accent:#60a5fa;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    html,body{height:100%;}
    body{
      margin:0;
      font-family:var(--sans);
      background:linear-gradient(180deg, #070b14, var(--bg));
      color:var(--text);
    }
    header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:16px;
      padding:14px 18px;
      border-bottom:1px solid var(--border);
      background:rgba(2,6,23,.7);
      position:sticky;
      top:0;
      z-index:10;
      backdrop-filter: blur(8px);
    }
    header h1{
      margin:0;
      font-size:16px;
      font-weight:650;
      letter-spacing:.2px;
    }
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .pill{
      padding:4px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      background:rgba(15,23,42,.6);
      font-size:12px;
      color:var(--muted);
    }
    .pill strong{color:var(--text); font-weight:650;}
    main{
      padding:16px 18px 22px;
      display:grid;
      grid-template-columns: 1.4fr 1fr;
      gap:14px;
    }
    .card{
      background:rgba(15,23,42,.7);
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .card h2{
      margin:0 0 10px 0;
      font-size:13px;
      font-weight:700;
      color:#dbeafe;
      letter-spacing:.2px;
    }
    .sub{
      font-size:12px;
      color:var(--muted);
      margin-top:-6px;
      margin-bottom:10px;
    }
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    button{
      appearance:none;
      border:1px solid var(--border);
      background:linear-gradient(180deg, var(--btn2), var(--btn));
      color:var(--text);
      border-radius:10px;
      padding:9px 12px;
      font-size:12px;
      font-weight:650;
      cursor:pointer;
    }
    button:hover{border-color:#334155;}
    button:disabled{
      opacity:.5;
      cursor:not-allowed;
    }
    .btnDanger{border-color:rgba(239,68,68,.35);}
    .btnDanger:hover{border-color:rgba(239,68,68,.6);}
    .btnOk{border-color:rgba(34,197,94,.35);}
    .btnOk:hover{border-color:rgba(34,197,94,.6);}
    .input, textarea{
      width:100%;
      box-sizing:border-box;
      border:1px solid var(--border);
      background:rgba(2,6,23,.45);
      color:var(--text);
      border-radius:10px;
      padding:9px 10px;
      font-size:12px;
      outline:none;
    }
    textarea{min-height:70px; font-family:var(--sans);}
    .kv{display:grid; grid-template-columns: 120px 1fr; gap:6px 10px; font-size:12px; margin-top:6px;}
    .kv div{color:var(--muted);}
    .kv div b{color:var(--text); font-weight:650;}
    .statusLine{
      padding:10px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(2,6,23,.35);
      font-family:var(--mono);
      font-size:12px;
      white-space:pre-wrap;
      word-break:break-word;
      max-height:260px;
      overflow:auto;
    }
    .logBox{
      margin-top:10px;
      padding:10px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(2,6,23,.35);
      font-family:var(--mono);
      font-size:12px;
      white-space:pre;
      overflow:auto;
      max-height:320px;
    }
    .badge{font-size:11px; padding:2px 8px; border-radius:999px; border:1px solid var(--border); color:var(--muted);}
    .ok{color:var(--ok);}
    .warn{color:var(--warn);}
    .err{color:var(--err);}
    .imgWrap{
      border:1px solid var(--border);
      border-radius:12px;
      overflow:hidden;
      background:rgba(2,6,23,.35);
    }
    .imgWrap header{
      position:unset;
      background:transparent;
      border:0;
      padding:8px 10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .imgWrap header .t{font-size:12px; color:#dbeafe; font-weight:700;}
    .imgWrap img{
      width:100%;
      height:auto;
      display:block;
      background:#000;
    }
    .radioRow{display:flex; gap:10px; align-items:center; font-size:12px; color:var(--muted);}
    .toast{
      position:fixed;
      bottom:14px;
      left:14px;
      max-width:520px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(2,6,23,.85);
      color:var(--text);
      font-size:12px;
      box-shadow:0 10px 24px rgba(0,0,0,.35);
      display:none;
      white-space:pre-wrap;
      z-index:999;
    }
  </style>
</head>
<body>

<header>
  <h1>XArm6 Demo Dashboard</h1>
  <div class="row">
    <span class="pill">Mode: <strong id="pillMode">—</strong></span>
    <span class="pill">State: <strong id="pillState">—</strong></span>
    <span class="pill">Running: <strong id="pillRunning">—</strong></span>
  </div>
</header>

<main>
  <section class="card">
    <h2>Cameras</h2>
    <div class="sub">Base + wrist MJPEG feeds (via ZMQ backend)</div>

    <div class="row" style="justify-content:space-between;">
      <div class="row">
        <span class="badge" id="camBadge">camera: —</span>
      </div>
      <div class="row">
        <button class="btnOk" id="btnStartCameras">Start Cameras</button>
      </div>
    </div>

    <div class="grid2" style="margin-top:10px;">
      <div class="imgWrap">
        <header>
          <div class="t">Base</div>
          <div class="badge" id="baseStat">—</div>
        </header>
        <img id="imgBase" src="/video/base" alt="Base camera" />
      </div>
      <div class="imgWrap">
        <header>
          <div class="t">Wrist</div>
          <div class="badge" id="wristStat">—</div>
        </header>
        <img id="imgWrist" src="/video/wrist" alt="Wrist camera" />
      </div>
    </div>
  </section>

  <section class="card">
    <h2>Server Control</h2>
    <div class="sub">Start/stop policy server (HPC or Local). Shutdown cancels early even before job_id exists.</div>

    <div class="radioRow">
      <label><input type="radio" name="mode" value="local" id="modeLocal"> Local</label>
      <label><input type="radio" name="mode" value="hpc" id="modeHpc"> HPC</label>
      <span class="badge" id="cancelBadge" style="display:none;">cancel requested</span>
    </div>

    <div class="row" style="margin-top:10px;">
      <button class="btnOk" id="btnRunServer">Run Server</button>
      <button class="btnDanger" id="btnStopServer">Shutdown Server</button>
      <button id="btnCopyDetails">Copy Details</button>
    </div>

    <div class="kv" style="margin-top:10px;">
      <div>preferred_mode</div><div><b id="kvPreferred">—</b></div>
      <div>active_mode</div><div><b id="kvActive">—</b></div>
      <div>job_id</div><div><b id="kvJob">—</b></div>
      <div>remote</div><div><b id="kvRemote">—</b></div>
    </div>

    <div style="margin-top:10px;">
      <div class="badge">Orchestrator / Status Detail</div>
      <div class="statusLine" id="statusDetail">—</div>
    </div>
  </section>

  <section class="card">
    <h2>xArm Client</h2>
    <div class="sub">Runs your local client against ws://localhost:8000</div>

    <label class="badge">Prompt</label>
    <textarea id="promptBox" placeholder="Enter a prompt..."></textarea>

    <div class="row" style="margin-top:10px;">
      <button class="btnOk" id="btnRunXarm">Run xArm Client</button>
      <button class="btnDanger" id="btnStopXarm">Stop xArm Client</button>
      <span class="badge" id="xarmBadge">xarm: —</span>
    </div>

    <div class="logBox" id="xarmLog">—</div>
  </section>

  <section class="card">
    <h2>Local Policy Server Log</h2>
    <div class="sub">This shows local policy stdout/stderr (checkpoint errors show here).</div>
    <div class="row" style="justify-content:space-between;">
      <span class="badge" id="localLogBadge">local: —</span>
      <button id="btnClearLocalLog">Clear View</button>
    </div>
    <div class="logBox" id="localLog">—</div>
  </section>
</main>

<div class="toast" id="toast"></div>

<script>
  const els = {
    pillMode: document.getElementById('pillMode'),
    pillState: document.getElementById('pillState'),
    pillRunning: document.getElementById('pillRunning'),
    statusDetail: document.getElementById('statusDetail'),
    kvPreferred: document.getElementById('kvPreferred'),
    kvActive: document.getElementById('kvActive'),
    kvJob: document.getElementById('kvJob'),
    kvRemote: document.getElementById('kvRemote'),
    cancelBadge: document.getElementById('cancelBadge'),

    modeLocal: document.getElementById('modeLocal'),
    modeHpc: document.getElementById('modeHpc'),

    btnRunServer: document.getElementById('btnRunServer'),
    btnStopServer: document.getElementById('btnStopServer'),
    btnCopyDetails: document.getElementById('btnCopyDetails'),

    btnStartCameras: document.getElementById('btnStartCameras'),
    camBadge: document.getElementById('camBadge'),
    baseStat: document.getElementById('baseStat'),
    wristStat: document.getElementById('wristStat'),

    promptBox: document.getElementById('promptBox'),
    btnRunXarm: document.getElementById('btnRunXarm'),
    btnStopXarm: document.getElementById('btnStopXarm'),
    xarmBadge: document.getElementById('xarmBadge'),
    xarmLog: document.getElementById('xarmLog'),

    localLogBadge: document.getElementById('localLogBadge'),
    localLog: document.getElementById('localLog'),
    btnClearLocalLog: document.getElementById('btnClearLocalLog'),

    toast: document.getElementById('toast'),
  };

  function toast(msg){
    els.toast.textContent = msg;
    els.toast.style.display = 'block';
    setTimeout(()=>{ els.toast.style.display='none'; }, 4200);
  }

  async function fetchJSON(url, opts){
    const res = await fetch(url, opts);
    let data = null;
    try { data = await res.json(); } catch(e) {}
    if(!res.ok){
      const detail = data && (data.detail || data.message) ? (data.detail || data.message) : (res.status + " " + res.statusText);
      throw new Error(detail);
    }
    return data;
  }

  function selectedMode(){
    return els.modeHpc.checked ? "hpc" : "local";
  }

  function setModeRadio(value){
    els.modeLocal.checked = (value === "local");
    els.modeHpc.checked = (value === "hpc");
  }

  function classifyState(state){
    if(!state) return "";
    if(state.startsWith("ERROR")) return "err";
    if(state === "READY") return "ok";
    if(state === "IDLE") return "";
    return "warn";
  }

  async function pollStatus(){
    const s = await fetchJSON("/api/status");

    els.pillMode.textContent = s.server_mode ?? "—";
    els.pillState.textContent = s.state ?? "—";
    els.pillRunning.textContent = s.server_running ? "yes" : "no";

    els.kvPreferred.textContent = s.preferred_mode ?? "—";
    els.kvActive.textContent = s.active_mode ?? "—";
    els.kvJob.textContent = s.job_id ?? "—";
    els.kvRemote.textContent = (s.remote_ip && s.remote_port) ? (s.remote_ip + ":" + s.remote_port) : "—";

    els.statusDetail.textContent = (s.message && s.message.trim()) ? s.message : "—";

    if(s.hpc_cancel_requested){
      els.cancelBadge.style.display = "inline-block";
    } else {
      els.cancelBadge.style.display = "none";
    }

    // Radio sync:
    // - While busy/running => lock radios to server_mode (active)
    // - While idle => reflect preferred_mode and allow user changes
    const lockRadios = (s.server_running || s.busy);
    if(lockRadios){
      setModeRadio(s.server_mode);
    } else {
      setModeRadio(s.preferred_mode);
    }
    els.modeLocal.disabled = lockRadios;
    els.modeHpc.disabled = lockRadios;

    // Buttons
    els.btnRunServer.disabled = (s.server_running || s.busy);
    els.btnStopServer.disabled = !(s.server_running || s.busy);

    els.btnRunXarm.disabled = (s.state !== "READY");
    els.btnStopXarm.disabled = false;

    // State color hint (only the text)
    els.pillState.style.color =
      (s.state && s.state.startsWith("ERROR")) ? "var(--err)" :
      (s.state === "READY") ? "var(--ok)" : "var(--text)";
  }

  function camOkFlag(obj){
    // Support either schema:
    // - {online: bool} (current backend)
    // - {ok: bool, error: str} (older)
    if(!obj) return { ok: false, err: false };
    if(typeof obj.online === "boolean") return { ok: obj.online, err: !obj.online };
    if(typeof obj.ok === "boolean") return { ok: obj.ok, err: !obj.ok };
    if(obj.error) return { ok: false, err: true };
    return { ok: false, err: false };
  }

  async function pollCameras(){
    const c = await fetchJSON("/api/camera-status");
    els.camBadge.textContent = c.server_running ? "camera: running" : "camera: stopped";
    els.camBadge.className = "badge " + (c.server_running ? "ok" : "warn");

    const b = camOkFlag(c.base);
    const w = camOkFlag(c.wrist);

    els.baseStat.textContent = b.ok ? "ok" : (b.err ? "err" : "—");
    els.baseStat.className = "badge " + (b.ok ? "ok" : (b.err ? "err" : ""));

    els.wristStat.textContent = w.ok ? "ok" : (w.err ? "err" : "—");
    els.wristStat.className = "badge " + (w.ok ? "ok" : (w.err ? "err" : ""));
  }

  async function pollLogs(){
    const p = await fetchJSON("/api/policy-server-log");
    // Current backend returns:
    // { local_running, local_returncode, log, mode }
    const localRunning = !!p.local_running;
    const rc = (p.local_returncode === null || typeof p.local_returncode === "undefined") ? null : p.local_returncode;

    els.localLogBadge.textContent = localRunning
      ? "local: running"
      : ("local: stopped" + (rc !== null ? (" (rc=" + rc + ")") : ""));

    els.localLog.textContent = (p.log && p.log.length) ? p.log : "—";
  }

  async function pollXarm(){
    const x = await fetchJSON("/api/xarm-status");
    els.xarmBadge.textContent = x.running
      ? "xarm: running"
      : ("xarm: stopped" + (x.returncode !== null && x.returncode !== undefined ? (" (rc=" + x.returncode + ")") : ""));
    els.xarmLog.textContent = (x.log && x.log.length) ? x.log : "—";
  }

  // Actions
  els.btnRunServer.addEventListener("click", async ()=>{
    try{
      const mode = selectedMode();
      await fetchJSON("/api/run-server", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({mode})
      });
      toast("Server start requested (" + mode + ").");
    }catch(e){
      toast("Run server failed: " + e.message);
    }
  });

  els.btnStopServer.addEventListener("click", async ()=>{
    try{
      const r = await fetchJSON("/api/stop-server", { method:"POST" });
      toast("Stop requested: " + (r.detail || "ok"));
    }catch(e){
      toast("Stop failed: " + e.message);
    }
  });

  els.btnCopyDetails.addEventListener("click", async ()=>{
    try{
      await navigator.clipboard.writeText(els.statusDetail.textContent || "");
      toast("Copied status detail to clipboard.");
    }catch(e){
      toast("Copy failed: " + e.message);
    }
  });

  els.btnStartCameras.addEventListener("click", async ()=>{
    try{
      await fetchJSON("/api/start-cameras", { method:"POST" });
      toast("Camera server start requested.");
    }catch(e){
      toast("Start cameras failed: " + e.message);
    }
  });

  els.modeLocal.addEventListener("change", async ()=>{
    if(!els.modeLocal.checked) return;
    try{
      await fetchJSON("/api/set-mode", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({mode:"local"})
      });
      toast("Preferred mode set to LOCAL.");
    }catch(e){
      toast("Set mode failed: " + e.message);
    }
  });

  els.modeHpc.addEventListener("change", async ()=>{
    if(!els.modeHpc.checked) return;
    try{
      await fetchJSON("/api/set-mode", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({mode:"hpc"})
      });
      toast("Preferred mode set to HPC.");
    }catch(e){
      toast("Set mode failed: " + e.message);
    }
  });

  els.btnRunXarm.addEventListener("click", async ()=>{
    try{
      const prompt = (els.promptBox.value || "").trim();
      await fetchJSON("/api/run-xarm", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({prompt})
      });
      toast("xArm client started.");
    }catch(e){
      toast("Run xArm failed: " + e.message);
    }
  });

  els.btnStopXarm.addEventListener("click", async ()=>{
    try{
      await fetchJSON("/api/stop-xarm", { method:"POST" });
      toast("Stop xArm requested.");
    }catch(e){
      toast("Stop xArm failed: " + e.message);
    }
  });

  els.btnClearLocalLog.addEventListener("click", ()=>{
    els.localLog.textContent = "—";
    toast("Cleared local log view (server still retains recent lines).");
  });

  // default prompt
  els.promptBox.value = "Pick a ripe, red tomato and drop it in the blue bucket. [crop=tomato]";

  async function loop(){
    try { await pollStatus(); } catch(e){ /* ignore */ }
    try { await pollCameras(); } catch(e){ /* ignore */ }
    try { await pollLogs(); } catch(e){ /* ignore */ }
    try { await pollXarm(); } catch(e){ /* ignore */ }
  }

  loop();
  setInterval(loop, 1200);
</script>
</body>
</html>
